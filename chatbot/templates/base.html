<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Universitaria de Colombia - {% block title %} {% endblock %}</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="d-flex flex-column min-vh-100">

<nav class="navbar navbar-expand-lg navbar-dark">
<div class="container">
<a class="navbar-brand" href="{{url_for('base')}}">
<img src="https://universitariadecolombia.edu.co/wp-content/uploads/2022/02/imagenlogop2.png" alt="Logo Universitaria de Colombia">
</a>
<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
<span class="navbar-toggler-icon"></span>
</button>
<div class="collapse navbar-collapse" id="navbarNav">
<ul class="navbar-nav ms-auto">
<li class="nav-item">
<a class="nav-link" href="{{url_for('mision')}}">
<i class="fas fa-bullseye me-1"></i> Misión
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="{{url_for('vision')}}">
<i class="fas fa-eye me-1"></i> Visión
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="{{url_for('lista_carreras')}}">
<i class="fas fa-list me-1"></i> Lista de Carreras
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="{{url_for('predict')}}">
<i class="far fa-comment-alt me-1"></i> ChatBox 
</a>
</li>
</ul>
</div>
</div>
</nav>

<main class="container my-5 flex-grow-1">
{% block content %} {% endblock %}
</main>

<!-- Chatbot emergente para agendar citas de motos -->
<div class="chat-button" id="chat-button">
    <i class="fas fa-motorcycle fa-2x"></i>
</div>

<div class="chat-container" id="chat-container">
    <div class="chat-header">
        <span>Asistente de Citas</span>
        <span id="close-chat" style="cursor: pointer;"><i class="fas fa-times"></i></span>
    </div>
    <div class="chat-messages" id="chat-messages">
        <div class="message-container">
            <div class="message bot-message">
                ¡Hola! Soy el asistente para agendar citas de mantenimiento de motos. ¿En qué puedo ayudarte?  
            </div>
        </div>
    </div>
    <div class="chat-input">
        <form id="chat-form">
            <div class="input-group">
                <input type="text" class="form-control" id="mensaje" placeholder="Escribe tu mensaje...">
                <button class="btn btn-primary" type="submit">Enviar</button>
            </div>
        </form>
    </div>
</div>

<style>
    .chat-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        background: #00132c;
        color: white;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 999;
    }
    
    .chat-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 350px;
        height: 500px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        display: none;
        flex-direction: column;
        z-index: 1000;
    }
    
    .chat-header {
        background: #00132c;
        color: white;
        padding: 10px 15px;
        border-radius: 10px 10px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .chat-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        max-height: 380px;
    }
    
    .chat-input {
        padding: 10px;
        border-top: 1px solid #eee;
    }
    
    .message {
        margin-bottom: 10px;
        padding: 8px 12px;
        border-radius: 15px;
        max-width: 80%;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .user-message {
        background: #e9e9eb;
        align-self: flex-end;
        margin-left: auto;
    }
    
    .bot-message {
        background: #00132c;
        color: white;
        align-self: flex-start;
    }
    
    .message-container {
        display: flex;
        flex-direction: column;
    }
    
    .chat-messages::-webkit-scrollbar {
        width: 6px;
    }
    
    .chat-messages::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    .chat-messages::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }
    
    .chat-messages::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        // Mostrar/ocultar chat
        $("#chat-button").click(function() {
            $("#chat-container").toggle();
            $("#chat-button").toggle();
            
            // Si el chat se abre, verificar si hay una sesión activa
            if ($("#chat-container").is(":visible")) {
                $.ajax({
                    url: "/verificar_sesion_chat",
                    type: "GET",
                    success: function(response) {
                        if (response.sesion_activa) {
                            addMessage("Has vuelto. ¿Qué deseas hacer?\n1. Agendar cita\n2. Ver citas agendadas\n3. Salir", "bot");
                        } else {
                            // El mensaje inicial ya está en el HTML, no es necesario agregarlo
                        }
                    },
                    error: function() {
                        // El mensaje inicial ya está en el HTML, no es necesario agregarlo
                    }
                });
            }
        });

        $("#close-chat").click(function() {
            $("#chat-container").hide();
            $("#chat-button").show();
        });

        // Enviar mensaje
        $("#chat-form").submit(function(e) {
            e.preventDefault();
            var mensaje = $("#mensaje").val().trim();
            if (mensaje) {
                // Agregar mensaje del usuario al chat
                addMessage(mensaje, "user");
                $("#mensaje").val("");
                
                // Enviar mensaje al servidor
                $.ajax({
                    url: "/procesar_chat_moto",
                    type: "POST",
                    data: {
                        mensaje: mensaje
                    },
                    success: function(response) {
                        // Agregar respuesta del bot al chat
                        addMessage(response.respuesta, "bot");
                    },
                    error: function() {
                        addMessage("Lo siento, ocurrió un error. Por favor, intenta de nuevo más tarde.", "bot");
                    }
                });
            }
        });

        function addMessage(text, sender) {
            var messageClass = sender === "user" ? "user-message" : "bot-message";
            var messageHtml = `
                <div class="message-container">
                    <div class="message ${messageClass}">${text.replace(/\n/g, '<br>')}</div>
                </div>
            `;
            $("#chat-messages").append(messageHtml);
            
            // Auto-scroll al final del historial
            $("#chat-messages").animate({ scrollTop: $("#chat-messages")[0].scrollHeight }, "fast");
        }
    });
</script>

<footer class="mt-auto py-4 text-white-50 text-center">
<div class="container">
<div class="row">
<div class="col-md-6">
<p class="mb-0">&copy; 2023 Universitaria de Colombia. Todos los derechos reservados.</p>
</div>
<div class="col-md-6">
<p class="mb-0">
<i class="fas fa-globe me-2"></i> Visítenos en
<a href="https://www.google.com" target="_blank">Internet</a>
</p>
</div>
</div>
</div>
</footer>
</body>
</html>